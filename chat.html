<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Example</title>
    <style>
        /* styles.css */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        #chat-screen,
        #chat-screen2 {
            flex: 1;
            border: 1px solid #ccc;
            padding: 20px;
            overflow-y: auto;
        }

        #chat-screen {
            background-color: #f0f0f0;
            width: 25%;
            border-right: 1px solid #f2f2f2;
        }

        #chat-screen2 {
            background-color: #e0e0e0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="chat-screen"></div>
        <div id="chat-screen2"></div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js"></script>
    <script>
        // script.js
        const firebaseConfig = {
            apiKey: "AIzaSyAOet6ztiBd15SJ7GhZS6WH1tBd8q9-cOo",
            authDomain: "sinapse-neurocare-53ffc.firebaseapp.com",
            projectId: "sinapse-neurocare-53ffc",
            storageBucket: "sinapse-neurocare-53ffc.appspot.com",
            messagingSenderId: "247071047127",
            appId: "1:247071047127:web:ed6487ff5f8088a8b55f92",
            measurementId: "G-0PLBNLT4HE",
            databaseURL: "https://sinapse-neurocare-53ffc-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        document.addEventListener('DOMContentLoaded', async function () {
            const chatScreen = document.getElementById('chat-screen');
            const chatScreen2 = document.getElementById('chat-screen2');
            const userId = "someUserId";  // Replace with the actual user ID

            let chats = [];
            let chatScreen2State = '';
            let chatScreen2Type = '';

            function handleStateChange(newState, newType) {
                chatScreen2State = newState;
                chatScreen2Type = newType;
                updateChatScreen2();
            }

            function updateChatScreen2() {
                chatScreen2.textContent = `State: ${chatScreen2State}, Type: ${chatScreen2Type}`;
            }

            async function fetchImage() {
                const storageRef = storage.ref(`Perfil/${userId}/`);
                const files = await storageRef.listAll();
                if (files.items.length > 0) {
                    const imageUrl = await files.items[0].getDownloadURL();
                    const imgElement = document.createElement('img');
                    imgElement.src = imageUrl;
                    imgElement.style.width = '40px';
                    imgElement.style.height = '40px';
                    imgElement.style.borderRadius = '50%';
                    chatScreen.appendChild(imgElement);
                }
            }

            await fetchImage();

            const messagesRef = database.ref('talk');
            const groupsRef = database.ref('group');

            messagesRef.on('child_added', snapshot => {
                const data = snapshot.val();
                if (data.user1.cod === userId || data.user2.cod === userId) {
                    chats.push(data);
                    renderChats();
                }
            });

            messagesRef.on('child_changed', snapshot => {
                const data = snapshot.val();
                if (data.user1.cod === userId || data.user2.cod === userId) {
                    const index = chats.findIndex(chat => chat.id === data.id);
                    if (index !== -1) {
                        chats[index] = data;
                        renderChats();
                    }
                }
            });

            groupsRef.on('child_added', snapshot => {
                const data = snapshot.val();
                if (data.members.some(member => member.member.cod === userId)) {
                    chats.push(data);
                    renderChats();
                }
            });

            groupsRef.on('child_changed', snapshot => {
                const data = snapshot.val();
                if (data.members.some(member => member.member.cod === userId)) {
                    const index = chats.findIndex(chat => chat.id === data.id);
                    if (index !== -1) {
                        chats[index] = data;
                        renderChats();
                    }
                }
            });

            function renderChats() {
                chatScreen.innerHTML = '';
                chats.sort((a, b) => b.lastMessage.timestamp - a.lastMessage.timestamp);
                chats.forEach(chat => {
                    const chatElement = document.createElement('div');
                    chatElement.textContent = chat.lastMessage.message;
                    chatElement.addEventListener('click', () => handleStateChange(chat.id, chat.tipo));
                    chatScreen.appendChild(chatElement);
                });
            }
        });


    </script>
</body>

</html>